//
//  ExploitConfig.swift
//  Queen-IOKit
//
//  Created by Cookie on 6/1/24.
//

import Foundation


@objc
protocol Exploit {
    func configure() -> Bool
    func run() -> Bool
}

class Checkm8: Exploit {
    let dfu: DfuDevice
    var config: ExploitConfig?
    var overwrite: [UInt8]?
    var shellcode: [UInt8]?
    
    init(dfu: inout DfuDevice, config: ExploitConfig? = nil, overwrite: [UInt8]? = nil, shellcode: [UInt8]? = nil) {
        self.dfu = dfu
        self.config = config
        self.overwrite = overwrite
        self.shellcode = shellcode
    }
    
    func configure() -> Bool {
        do {
            self.config = try ExploitConfig(withCpid: 0x8015)
        } catch ExploitConfigError.DeviceNotSupported(let cpid) {
            print("Device with CPID:\(cpid) is not supported")
            return false
        } catch let e {
            print(e.localizedDescription)
            return false
        }
        return true
    }
    
    func run() -> Bool {
        do {
            print(try config?.asmArm64X7Trampoline(address: 0x18000c000))
            print(try config?.asmArm64Branch(source: 0x10, destination: 0x0))
        } catch ExploitConfigError.PackingError {
            print("Error occurred while packing bytes")
        } catch ExploitConfigError.FileNotFound(fileName: let fileName) {
            print("File \(fileName) was not found")
        } catch let e {
            print(e.localizedDescription)
        }
        
        return true
    }
}
